{{ define "staff.html" }}
<section class="card">
  <h1>Maintenance Staff Portal</h1>
  <p class="muted">You will only see tickets assigned to you. You can update status and chat with admin for those tickets.</p>

  <div class="row">
    <div class="pill">You: <span id="me">loading…</span></div>
    <div class="pill">SSE: <span id="sseStatus">connecting…</span></div>
    <button id="logout" class="secondary">Logout</button>
    <button id="refresh" class="secondary">Refresh</button>
  </div>

  <div class="grid2" style="margin-top:12px;">
    <div>
      <h2>Live Events</h2>
      <div id="events" class="events"></div>
    </div>

    <div>
      <h2>Your Assigned Tickets</h2>
      <div id="tickets"></div>
    </div>
  </div>
</section>

<script>
function esc(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

async function api(path, opts) {
  const res = await fetch(path, opts);
  const out = await res.json().catch(()=> ({}));
  return {res, out};
}

async function loadMe() {
  const {res, out} = await api('/api/me');
  if (!res.ok || out.role !== 'STAFF') { location.href='/login'; return; }
  document.getElementById('me').textContent = `${out.username} (${out.role})`;
}

function renderChatLine(m) {
  const t = m.sent_at ? new Date(m.sent_at).toLocaleTimeString() : '';
  return `<div class="eventLine">
    <span class="muted">${esc(t)}</span>
    <b>${esc(m.from_username || '')}</b>
    <span class="muted">(${esc(m.from_role || '')})</span>:
    ${esc(m.message || '')}
  </div>`;
}

async function loadChat(ticketId) {
  const box = document.getElementById(`chatBox-${ticketId}`);
  const status = document.getElementById(`chatStatus-${ticketId}`);
  if (!box) return;
  status.textContent = 'loading chat...';

  const {res, out} = await api(`/api/tickets/${ticketId}/chat`);
  if (!res.ok) { status.textContent = out.error || 'chat error'; return; }

  const msgs = out.messages || [];
  box.innerHTML = msgs.map(renderChatLine).join('');
  status.textContent = msgs.length ? '' : 'no messages yet';
  box.scrollTop = box.scrollHeight;
}

async function sendChat(ticketId) {
  const input = document.getElementById(`chatInput-${ticketId}`);
  const status = document.getElementById(`chatStatus-${ticketId}`);
  const msg = (input.value || '').trim();
  if (!msg) { status.textContent = 'type a message'; return; }

  status.textContent = 'sending...';
  const {res, out} = await api(`/api/tickets/${ticketId}/chat`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({message: msg})
  });

  if (!res.ok) { status.textContent = out.error || 'send failed'; return; }
  input.value = '';
  status.textContent = '';
  await loadChat(ticketId);
}

async function fetchTickets() {
  const {res, out} = await api('/api/tickets');
  const el = document.getElementById('tickets');
  if (!res.ok) { el.innerHTML = `<p class="muted">${esc(out.error||'error')}</p>`; return; }
  if (!Array.isArray(out) || out.length===0) { el.innerHTML='<p class="muted">No assigned tickets right now.</p>'; return; }

  el.innerHTML = out.map(t => `
    <div class="issue">
      <div class="issue-head">
        <div class="badge">${esc(t.type)}</div>
        <div class="muted">#${t.id} • room ${esc(t.room)} • ${new Date(t.created_at).toLocaleString()}</div>
        <div class="status">${esc(t.status)}</div>
      </div>
      <div class="issue-body">${esc(t.description)}</div>

      <div class="row">
        <label class="muted">Status</label>
        <select data-id="${t.id}" class="statusSelect">
          <option value="OPEN" ${t.status==="OPEN"?"selected":""}>OPEN</option>
          <option value="IN_PROGRESS" ${t.status==="IN_PROGRESS"?"selected":""}>IN_PROGRESS</option>
          <option value="RESOLVED" ${t.status==="RESOLVED"?"selected":""}>RESOLVED</option>
        </select>
        <button class="secondary statusBtn" data-id="${t.id}">Update</button>
        <span class="muted" id="statusMsg-${t.id}"></span>
      </div>

      <!-- Chat panel -->
      <div class="card subtle" style="margin-top:10px;">
        <div class="row" style="justify-content:space-between;">
          <h3 style="margin:0;">Ticket Chat</h3>
          <button class="secondary chatLoadBtn" data-id="${t.id}">Load</button>
        </div>
        <div id="chatBox-${t.id}" class="events" style="max-height:160px; overflow:auto;"></div>
        <div class="row" style="margin-top:8px;">
          <input id="chatInput-${t.id}" placeholder="Type a message…" style="flex:1;" />
          <button class="secondary chatSendBtn" data-id="${t.id}">Send</button>
        </div>
        <div id="chatStatus-${t.id}" class="muted"></div>
      </div>
    </div>
  `).join('');

  // auto-load chat for first few tickets
  out.slice(0, 3).forEach(t => loadChat(t.id));
}

async function updateStatus(id) {
  const sel = document.querySelector(`select.statusSelect[data-id="${id}"]`);
  const msg = document.getElementById(`statusMsg-${id}`);
  msg.textContent = "updating...";
  const {res, out} = await api(`/api/tickets/${id}/status`, {
    method:'PATCH',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({status: sel.value})
  });
  if (!res.ok) { msg.textContent = out.error || 'error'; return; }
  msg.textContent = "updated";
  fetchTickets();
}

document.addEventListener('click', (e)=>{
  if (e.target.classList.contains('statusBtn')) updateStatus(e.target.getAttribute('data-id'));
  if (e.target.classList.contains('chatLoadBtn')) loadChat(e.target.getAttribute('data-id'));
  if (e.target.classList.contains('chatSendBtn')) sendChat(e.target.getAttribute('data-id'));
});

document.getElementById('refresh').addEventListener('click', fetchTickets);

document.getElementById('logout').addEventListener('click', async ()=>{
  await api('/api/auth/logout', {method:'POST'});
  location.href='/login';
});

// SSE events
const sseStatus = document.getElementById('sseStatus');
const eventsEl = document.getElementById('events');
function addEventLine(obj) {
  const t = new Date().toLocaleTimeString();
  const pretty = esc(JSON.stringify(obj));
  eventsEl.innerHTML = `<div class="eventLine"><span class="muted">${t}</span> ${pretty}</div>` + eventsEl.innerHTML;
}

function handleIncoming(obj) {
  if (obj && obj.topic && obj.payload) {
    addEventLine(obj);

    if (String(obj.topic).startsWith('smarthotel/chat/ticket/')) {
      const p = obj.payload;
      const ticketId = p.ticket_id;
      const box = document.getElementById(`chatBox-${ticketId}`);
      if (box) {
        box.innerHTML += renderChatLine(p);
        box.scrollTop = box.scrollHeight;
        const st = document.getElementById(`chatStatus-${ticketId}`);
        if (st) st.textContent = '';
      }
    }
    return;
  }
  addEventLine(obj);
}

const es = new EventSource('/api/stream');
es.onopen = () => { sseStatus.textContent = 'connected'; };
es.onerror = () => { sseStatus.textContent = 'disconnected'; };
es.onmessage = (e) => {
  try { handleIncoming(JSON.parse(e.data)); }
  catch { handleIncoming({event:"invalid_json", raw:e.data}); }
  // optional refresh on non-chat events
  fetchTickets();
};

(async ()=>{
  await loadMe();
  await fetchTickets();
})();
</script>
{{ end }}
